<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Guild Housing Claims</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .draggable {
            cursor: move;
        }
        .clickable {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="app"></div>

    <script>
        const MAP_URL = 'https://i.imgur.com/dPlVOwx.jpg';
        const HOUSE_ICON = 'https://i.imgur.com/g7sDEws.png';
        const FLIGHT_ICON = 'https://i.imgur.com/lkOGnpR.png';
        const PORTAL_ICON = 'https://i.imgur.com/G2ErFnA.png';

        const classes = [
            'Death Knight', 'Demon Hunter', 'Druid', 'Evoker', 'Hunter', 'Mage',
            'Monk', 'Paladin', 'Priest', 'Rogue', 'Shaman', 'Warlock', 'Warrior'
        ];

        const classColors = {
            'Death Knight': '#C41E3A',
            'Demon Hunter': '#A330C9',
            'Druid': '#FF7C0A',
            'Evoker': '#33937F',
            'Hunter': '#AAD372',
            'Mage': '#3FC7EB',
            'Monk': '#00FF98',
            'Paladin': '#F48CBA',
            'Priest': '#FFFFFF',
            'Rogue': '#FFF468',
            'Shaman': '#0070DD',
            'Warlock': '#8788EE',
            'Warrior': '#C69B6D'
        };

        const EDIT_PASSWORD = 'housing2025'; // Change this to your desired password

        let state = {
            claims: {},
            plots: [],
            flightPaths: [],
            portals: [],
            editMode: false,
            placementMode: null,
            filter: 'all',
            selectedPlot: null,
            draggedItem: null,
            dragOffset: { x: 0, y: 0 },
            showHouseIds: true
        };

        // Load from localStorage
        function loadState() {
            const saved = localStorage.getItem('wowHousingData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.claims = data.claims || {};
                    state.plots = data.plots || [];
                    state.flightPaths = data.flightPaths || [];
                    state.portals = data.portals || [];
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function saveState() {
            const data = {
                claims: state.claims,
                plots: state.plots,
                flightPaths: state.flightPaths,
                portals: state.portals
            };
            localStorage.setItem('wowHousingData', JSON.stringify(data));
        }

        function exportData() {
            const data = {
                plots: state.plots,
                flightPaths: state.flightPaths,
                portals: state.portals,
                claims: state.claims
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'guild-housing-data.json';
            link.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            if (imported.plots) state.plots = imported.plots;
                            if (imported.flightPaths) state.flightPaths = imported.flightPaths;
                            if (imported.portals) state.portals = imported.portals;
                            if (imported.claims) state.claims = imported.claims;
                            saveState();
                            render();
                        } catch (err) {
                            alert('Error importing file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function handleMapClick(e) {
            if (!state.editMode || !state.placementMode) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            if (state.placementMode === 'plot') {
                const newId = state.plots.length > 0 ? Math.max(...state.plots.map(p => p.id)) + 1 : 1;
                state.plots.push({ id: newId, x, y });
            } else if (state.placementMode === 'flight') {
                const newId = state.flightPaths.length > 0 ? Math.max(...state.flightPaths.map(f => f.id)) + 1 : 1;
                state.flightPaths.push({ id: newId, x, y });
            } else if (state.placementMode === 'portal') {
                const newId = state.portals.length > 0 ? Math.max(...state.portals.map(p => p.id)) + 1 : 1;
                state.portals.push({ id: newId, x, y });
            }
            saveState();
            render();
        }

        function startDrag(e, type, item) {
            if (!state.editMode) return;
            e.stopPropagation();
            
            const rect = e.currentTarget.getBoundingClientRect();
            state.draggedItem = { type, item };
            state.dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function handleMouseMove(e) {
            if (!state.draggedItem || !state.editMode) return;
            
            const mapContainer = document.getElementById('map-container');
            const rect = mapContainer.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            if (state.draggedItem.type === 'plot') {
                const plot = state.plots.find(p => p.id === state.draggedItem.item.id);
                if (plot) {
                    plot.x = x;
                    plot.y = y;
                }
            } else if (state.draggedItem.type === 'flight') {
                const flight = state.flightPaths.find(f => f.id === state.draggedItem.item.id);
                if (flight) {
                    flight.x = x;
                    flight.y = y;
                }
            } else if (state.draggedItem.type === 'portal') {
                const portal = state.portals.find(p => p.id === state.draggedItem.item.id);
                if (portal) {
                    portal.x = x;
                    portal.y = y;
                }
            }
            render();
        }

        function handleMouseUp() {
            if (state.draggedItem) {
                saveState();
                state.draggedItem = null;
                render();
            }
        }

        function deleteItem(e, type, id) {
            e.stopPropagation();
            e.preventDefault();
            
            if (type === 'plot') {
                state.plots = state.plots.filter(p => p.id !== id);
                delete state.claims[id];
            } else if (type === 'flight') {
                state.flightPaths = state.flightPaths.filter(f => f.id !== id);
            } else if (type === 'portal') {
                state.portals = state.portals.filter(p => p.id !== id);
            }
            saveState();
            render();
        }

        function openClaimModal(plotId) {
            if (state.editMode) return;
            state.selectedPlot = plotId;
            render();
        }

        function closeClaimModal() {
            state.selectedPlot = null;
            render();
        }

        function handleClaim(character, player, cls) {
            if (character && player) {
                state.claims[state.selectedPlot] = { character, player, class: cls };
                saveState();
                closeClaimModal();
            }
        }

        function handleUnclaim() {
            delete state.claims[state.selectedPlot];
            saveState();
            closeClaimModal();
        }

        function getFilteredPlots() {
            return state.plots.filter(plot => {
                if (state.filter === 'all') return true;
                if (state.filter === 'claimed') return state.claims[plot.id];
                if (state.filter === 'unclaimed') return !state.claims[plot.id];
                return state.claims[plot.id]?.class === state.filter;
            });
        }

        function render() {
            const claimedCount = Object.keys(state.claims).length;
            const filteredPlots = getFilteredPlots();

            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- Header -->
                <div class="bg-gray-800 p-4 border-b border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="text-yellow-500 text-2xl">üè†</div>
                            <h1 class="text-2xl font-bold">WoW Alliance Housing Claims</h1>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 text-sm">
                                <span>üë•</span>
                                <span>${claimedCount}/${state.plots.length} Claimed</span>
                            </div>
                            <button onclick="toggleEditMode()" class="flex items-center gap-2 px-3 py-2 rounded text-sm ${state.editMode ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-purple-600 hover:bg-purple-700'}">
                                ${state.editMode ? '‚úì Done Editing' : '‚úèÔ∏è Edit Mode'}
                            </button>
                            <button onclick="toggleHouseIds()" class="flex items-center gap-2 px-3 py-2 rounded text-sm ${state.showHouseIds ? 'bg-gray-600 hover:bg-gray-700' : 'bg-gray-700 hover:bg-gray-600'}">
                                ${state.showHouseIds ? 'üëÅÔ∏è Hide IDs' : 'üëÅÔ∏è Show IDs'}
                            </button>
                            <button onclick="exportData()" class="flex items-center gap-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                                ‚¨áÔ∏è Export
                            </button>
                            <button onclick="importData()" class="flex items-center gap-2 px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-sm">
                                ‚¨ÜÔ∏è Import
                            </button>
                        </div>
                    </div>

                    ${state.editMode ? `
                        <div class="mb-4 p-3 bg-gray-900 rounded border border-yellow-500">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-semibold text-yellow-400">Placement Mode:</div>
                                <button onclick="clearAll()" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs font-semibold">
                                    üóëÔ∏è Clear All
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="setPlacementMode('plot')" class="flex items-center gap-2 px-3 py-2 rounded text-sm ${state.placementMode === 'plot' ? 'bg-yellow-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                    ‚ûï Place Houses (${state.plots.length})
                                </button>
                                <button onclick="setPlacementMode('flight')" class="flex items-center gap-2 px-3 py-2 rounded text-sm ${state.placementMode === 'flight' ? 'bg-yellow-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                    ‚ûï Place Flight Paths (${state.flightPaths.length})
                                </button>
                                <button onclick="setPlacementMode('portal')" class="flex items-center gap-2 px-3 py-2 rounded text-sm ${state.placementMode === 'portal' ? 'bg-yellow-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                    ‚ûï Place Portals (${state.portals.length})
                                </button>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">
                                ${state.placementMode ? 'Click on the map to place items. Drag to reposition.' : 'Select a placement mode, then click on the map.'}
                            </div>
                        </div>
                    ` : `
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="setFilter('all')" class="px-3 py-1 rounded text-sm ${state.filter === 'all' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                All
                            </button>
                            <button onclick="setFilter('claimed')" class="px-3 py-1 rounded text-sm ${state.filter === 'claimed' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                Claimed
                            </button>
                            <button onclick="setFilter('unclaimed')" class="px-3 py-1 rounded text-sm ${state.filter === 'unclaimed' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                Unclaimed
                            </button>
                            <div class="w-px bg-gray-600 mx-2"></div>
                            ${classes.map(cls => `
                                <button onclick="setFilter('${cls}')" class="px-3 py-1 rounded text-sm ${state.filter === cls ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}" style="${state.filter === cls ? `background-color: ${classColors[cls]}` : ''}">
                                    ${cls}
                                </button>
                            `).join('')}
                        </div>
                    `}
                </div>

                <!-- Map Container -->
                <div class="flex-1 overflow-auto bg-gray-950" style="height: calc(100vh - 200px);">
                    <div id="map-container" class="relative inline-block min-w-full" style="${state.editMode && state.placementMode ? 'cursor: crosshair;' : ''}">
                        <img src="${MAP_URL}" alt="WoW Housing Map" class="w-full h-auto" style="min-width: 1095px;">
                        
                        <!-- Flight Paths -->
                        ${state.flightPaths.map(flight => `
                            <div class="absolute transform -translate-x-1/2 -translate-y-1/2 ${state.editMode ? 'draggable' : ''}" 
                                 style="left: ${flight.x}%; top: ${flight.y}%;"
                                 onmousedown="startDragItem(event, 'flight', ${flight.id})">
                                <div class="relative">
                                    <img src="${FLIGHT_ICON}" alt="Flight Path" class="w-10 h-10">
                                    ${state.editMode ? `
                                        <button onclick="deleteItem(event, 'flight', ${flight.id})" class="absolute -top-2 -right-2 bg-red-600 rounded-full p-1 hover:bg-red-700 text-white text-xs">
                                            ‚úï
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}

                        <!-- Portals -->
                        ${state.portals.map(portal => `
                            <div class="absolute transform -translate-x-1/2 -translate-y-1/2 ${state.editMode ? 'draggable' : ''}" 
                                 style="left: ${portal.x}%; top: ${portal.y}%;"
                                 onmousedown="startDragItem(event, 'portal', ${portal.id})">
                                <div class="relative">
                                    <img src="${PORTAL_ICON}" alt="Portal" class="w-10 h-10">
                                    ${state.editMode ? `
                                        <button onclick="deleteItem(event, 'portal', ${portal.id})" class="absolute -top-2 -right-2 bg-red-600 rounded-full p-1 hover:bg-red-700 text-white text-xs">
                                            ‚úï
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}

                        <!-- Plots -->
                        ${filteredPlots.map(plot => {
                            const claim = state.claims[plot.id];
                            const isClaimed = !!claim;
                            return `
                                <div class="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all ${state.editMode ? 'draggable' : 'clickable hover:scale-110'}" 
                                     style="left: ${plot.x}%; top: ${plot.y}%;"
                                     onmousedown="startDragItem(event, 'plot', ${plot.id})"
                                     onclick="${!state.editMode ? `openClaimModal(${plot.id})` : ''}">
                                    <div class="relative">
                                        <img src="${HOUSE_ICON}" alt="House Plot" class="w-10 h-10" style="${isClaimed ? `filter: drop-shadow(0 0 8px ${classColors[claim.class]})` : ''}">
                                        ${state.showHouseIds ? `
                                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold pointer-events-none"
                                                 style="color: ${isClaimed ? classColors[claim.class] : '#fff'}; text-shadow: 1px 1px 2px black, -1px -1px 2px black;">
                                                ${plot.id}
                                            </div>
                                        ` : ''}
                                        ${isClaimed && !state.editMode ? `
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-1 bg-black bg-opacity-90 px-2 py-1 rounded text-xs whitespace-nowrap pointer-events-none z-10">
                                                ${claim.character}
                                            </div>
                                        ` : ''}
                                        ${state.editMode ? `
                                            <button onclick="deleteItem(event, 'plot', ${plot.id})" class="absolute -top-2 -right-2 bg-red-600 rounded-full p-1 hover:bg-red-700 text-white text-xs z-20">
                                                ‚úï
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- Claim Modal -->
                ${state.selectedPlot !== null ? `
                    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="if(event.target === this) closeClaimModal()">
                        <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold">Plot #${state.selectedPlot}</h2>
                                <button onclick="closeClaimModal()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
                            </div>

                            ${state.claims[state.selectedPlot] ? `
                                <div class="space-y-4">
                                    <div class="bg-gray-900 p-4 rounded">
                                        <div class="text-sm text-gray-400 mb-1">Character</div>
                                        <div class="text-lg font-bold" style="color: ${classColors[state.claims[state.selectedPlot].class]}">
                                            ${state.claims[state.selectedPlot].character}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-2">Player</div>
                                        <div>${state.claims[state.selectedPlot].player}</div>
                                        <div class="text-sm text-gray-400 mt-2">Class</div>
                                        <div style="color: ${classColors[state.claims[state.selectedPlot].class]}">
                                            ${state.claims[state.selectedPlot].class}
                                        </div>
                                    </div>
                                    <button onclick="handleUnclaim()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded font-semibold">
                                        Unclaim Plot
                                    </button>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Character Name</label>
                                        <input type="text" id="character-input" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:outline-none focus:border-blue-500" placeholder="Enter character name">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Player Name (Discord/Real Name)</label>
                                        <input type="text" id="player-input" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:outline-none focus:border-blue-500" placeholder="Enter player name">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Class</label>
                                        <select id="class-select" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:outline-none focus:border-blue-500">
                                            ${classes.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
                                        </select>
                                    </div>
                                    <button onclick="submitClaim()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-semibold">
                                        Claim Plot
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;

            // Attach event listeners to map
            const mapContainer = document.getElementById('map-container');
            if (mapContainer) {
                mapContainer.onclick = handleMapClick;
                mapContainer.onmousemove = handleMouseMove;
                mapContainer.onmouseup = handleMouseUp;
            }
        }

        // Global functions
        window.toggleEditMode = function() {
            if (!state.editMode) {
                // Entering edit mode - require password
                const password = prompt('Enter edit mode password:');
                if (password !== EDIT_PASSWORD) {
                    alert('Incorrect password!');
                    return;
                }
            }
            state.editMode = !state.editMode;
            state.placementMode = null;
            render();
        };

        window.toggleHouseIds = function() {
            state.showHouseIds = !state.showHouseIds;
            render();
        };

        window.clearAll = function() {
            if (!confirm('Are you sure you want to clear ALL plots, flight paths, portals, and claims? This cannot be undone!')) {
                return;
            }
            state.plots = [];
            state.flightPaths = [];
            state.portals = [];
            state.claims = {};
            saveState();
            render();
        };

        window.setPlacementMode = function(mode) {
            state.placementMode = state.placementMode === mode ? null : mode;
            render();
        };

        window.setFilter = function(filter) {
            state.filter = filter;
            render();
        };

        window.startDragItem = function(e, type, id) {
            if (!state.editMode) return;
            const item = type === 'plot' ? state.plots.find(p => p.id === id) :
                        type === 'flight' ? state.flightPaths.find(f => f.id === id) :
                        state.portals.find(p => p.id === id);
            startDrag(e, type, item);
        };

        window.submitClaim = function() {
            const character = document.getElementById('character-input').value;
            const player = document.getElementById('player-input').value;
            const cls = document.getElementById('class-select').value;
            handleClaim(character, player, cls);
        };

        // Initialize
        loadState();
        render();
    </script>
</body>
</html>
