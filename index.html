<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potato Soup Housing Claims</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .clickable {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="app"></div>

    <script>
        // ============ CONFIGURATION ============
        const GITHUB_USERNAME = 'bnknkl';
        const GITHUB_REPO = 'potato-soup-housing';
        const DATA_FILE = 'data.json';
        
        const MAP_URL = 'https://i.imgur.com/dPlVOwx.jpg';
        const HOUSE_ICON = 'https://i.imgur.com/g7sDEws.png';
        const FLIGHT_ICON = 'https://i.imgur.com/lkOGnpR.png';
        const PORTAL_ICON = 'https://i.imgur.com/G2ErFnA.png';

        const classes = [
            'Death Knight', 'Demon Hunter', 'Druid', 'Evoker', 'Hunter', 'Mage',
            'Monk', 'Paladin', 'Priest', 'Rogue', 'Shaman', 'Warlock', 'Warrior'
        ];

        const classColors = {
            'Death Knight': '#C41E3A',
            'Demon Hunter': '#A330C9',
            'Druid': '#FF7C0A',
            'Evoker': '#33937F',
            'Hunter': '#AAD372',
            'Mage': '#3FC7EB',
            'Monk': '#00FF98',
            'Paladin': '#F48CBA',
            'Priest': '#FFFFFF',
            'Rogue': '#FFF468',
            'Shaman': '#0070DD',
            'Warlock': '#8788EE',
            'Warrior': '#C69B6D'
        };

        let state = {
            claims: {},
            plots: [],
            flightPaths: [],
            portals: [],
            filter: 'all',
            selectedPlot: null,
            showHouseIds: true,
            loading: true,
            lastUpdated: null
        };

        // ============ GITHUB API FUNCTIONS ============
        async function loadFromGitHub() {
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${DATA_FILE}`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    
                    state.claims = content.claims || {};
                    state.plots = content.plots || [];
                    state.flightPaths = content.flightPaths || [];
                    state.portals = content.portals || [];
                    state.lastUpdated = new Date().toLocaleString();
                    
                    console.log('Data loaded from GitHub');
                } else {
                    console.error('Failed to load data from GitHub:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading from GitHub:', error);
            } finally {
                state.loading = false;
                render();
            }
        }

        function openClaimModal(plotId) {
            state.selectedPlot = plotId;
            render();
        }

        function closeClaimModal() {
            state.selectedPlot = null;
            render();
        }

        function getFilteredPlots() {
            return state.plots.filter(plot => {
                if (state.filter === 'all') return true;
                if (state.filter === 'claimed') return state.claims[plot.id];
                if (state.filter === 'unclaimed') return !state.claims[plot.id];
                return state.claims[plot.id]?.class === state.filter;
            });
        }

        function render() {
            if (state.loading) {
                document.getElementById('app').innerHTML = `
                    <div class="flex items-center justify-center h-screen">
                        <div class="text-center">
                            <div class="text-2xl mb-4">Loading housing data...</div>
                            <div class="text-gray-400">Please wait</div>
                        </div>
                    </div>
                `;
                return;
            }

            const claimedCount = Object.keys(state.claims).length;
            const filteredPlots = getFilteredPlots();

            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- Header -->
                <div class="bg-gray-800 p-4 border-b border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="text-yellow-500 text-2xl">üè†</div>
                            <h1 class="text-2xl font-bold">Potato Soup Housing Claims</h1>
                            <div class="text-xs text-green-400 bg-green-900 px-2 py-1 rounded">
                                ‚òÅÔ∏è Loaded from GitHub
                            </div>
                            ${state.lastUpdated ? `
                                <div class="text-xs text-gray-400">
                                    Last updated: ${state.lastUpdated}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 text-sm">
                                <span>üë•</span>
                                <span>${claimedCount}/${state.plots.length} Claimed</span>
                            </div>
                            <button onclick="toggleHouseIds()" class="flex items-center gap-2 px-3 py-2 rounded text-sm ${state.showHouseIds ? 'bg-gray-600 hover:bg-gray-700' : 'bg-gray-700 hover:bg-gray-600'}">
                                ${state.showHouseIds ? 'üëÅÔ∏è Hide IDs' : 'üëÅÔ∏è Show IDs'}
                            </button>
                            <button onclick="refreshData()" class="flex items-center gap-2 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2 flex-wrap">
                        <button onclick="setFilter('all')" class="px-3 py-1 rounded text-sm ${state.filter === 'all' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            All
                        </button>
                        <button onclick="setFilter('claimed')" class="px-3 py-1 rounded text-sm ${state.filter === 'claimed' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            Claimed
                        </button>
                        <button onclick="setFilter('unclaimed')" class="px-3 py-1 rounded text-sm ${state.filter === 'unclaimed' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            Unclaimed
                        </button>
                        <div class="w-px bg-gray-600 mx-2"></div>
                        ${classes.map(cls => `
                            <button onclick="setFilter('${cls}')" class="px-3 py-1 rounded text-sm ${state.filter === cls ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}" style="${state.filter === cls ? `background-color: ${classColors[cls]}` : ''}">
                                ${cls}
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Map Container -->
                <div class="flex-1 overflow-auto bg-gray-950" style="height: calc(100vh - 150px);">
                    <div id="map-container" class="relative inline-block min-w-full">
                        <img src="${MAP_URL}" alt="WoW Housing Map" class="w-full h-auto" style="min-width: 1095px;">
                        
                        <!-- Flight Paths -->
                        ${state.flightPaths.map(flight => `
                            <div class="absolute transform -translate-x-1/2 -translate-y-1/2" 
                                 style="left: ${flight.x}%; top: ${flight.y}%;">
                                <img src="${FLIGHT_ICON}" alt="Flight Path" class="w-10 h-10">
                            </div>
                        `).join('')}

                        <!-- Portals -->
                        ${state.portals.map(portal => `
                            <div class="absolute transform -translate-x-1/2 -translate-y-1/2" 
                                 style="left: ${portal.x}%; top: ${portal.y}%;">
                                <img src="${PORTAL_ICON}" alt="Portal" class="w-10 h-10">
                            </div>
                        `).join('')}

                        <!-- Plots -->
                        ${filteredPlots.map(plot => {
                            const claim = state.claims[plot.id];
                            const isClaimed = !!claim;
                            return `
                                <div class="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all clickable hover:scale-110" 
                                     style="left: ${plot.x}%; top: ${plot.y}%;"
                                     onclick="openClaimModal(${plot.id})">
                                    <div class="relative">
                                        <img src="${HOUSE_ICON}" alt="House Plot" class="w-10 h-10" style="${isClaimed ? `filter: drop-shadow(0 0 8px ${classColors[claim.class]})` : ''}">
                                        ${state.showHouseIds ? `
                                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xs font-bold pointer-events-none"
                                                 style="color: ${isClaimed ? classColors[claim.class] : '#fff'}; text-shadow: 1px 1px 2px black, -1px -1px 2px black;">
                                                ${plot.id}
                                            </div>
                                        ` : ''}
                                        ${isClaimed ? `
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-1 bg-black bg-opacity-90 px-2 py-1 rounded text-xs whitespace-nowrap pointer-events-none z-10">
                                                ${claim.character}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- Claim Modal -->
                ${state.selectedPlot !== null ? `
                    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="if(event.target === this) closeClaimModal()">
                        <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold">Plot #${state.selectedPlot}</h2>
                                <button onclick="closeClaimModal()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
                            </div>

                            ${state.claims[state.selectedPlot] ? `
                                <div class="space-y-4">
                                    <div class="bg-gray-900 p-4 rounded">
                                        <div class="text-sm text-gray-400 mb-1">Character</div>
                                        <div class="text-lg font-bold" style="color: ${classColors[state.claims[state.selectedPlot].class]}">
                                            ${state.claims[state.selectedPlot].character}
                                        </div>
                                        <div class="text-sm text-gray-400 mt-2">Player</div>
                                        <div>${state.claims[state.selectedPlot].player}</div>
                                        <div class="text-sm text-gray-400 mt-2">Class</div>
                                        <div style="color: ${classColors[state.claims[state.selectedPlot].class]}">
                                            ${state.claims[state.selectedPlot].class}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-gray-900 p-4 rounded text-center">
                                    <div class="text-gray-400 mb-2">This plot is available!</div>
                                    <div class="text-sm text-gray-500">Contact an officer to claim it</div>
                                </div>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Global functions
        window.toggleHouseIds = function() {
            state.showHouseIds = !state.showHouseIds;
            render();
        };

        window.setFilter = function(filter) {
            state.filter = filter;
            render();
        };

        window.refreshData = async function() {
            state.loading = true;
            render();
            await loadFromGitHub();
        };

        // Initialize
        loadFromGitHub();
        
        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadFromGitHub();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
